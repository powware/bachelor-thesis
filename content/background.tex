% !TEX root = ../thesis.tex

\chapter{Background}

The following introduces the background information necessary to understand the employment of a \ac{UEFI} rootkit. This includes the general workings of the \acf{PI} and \ac{UEFI}, the \ac{UEFI} programming model and interface itself; as well as its security mechanisms. It is also necessary to understand our target's defenses, for this, we briefly describe the Window's security mechanisms faced when performing our attacks.

\section{\acf{UEFI}}

% general introduction to uefi
interface between operating system and platform firmware
data datables containing platform-related information
boot- and runttime service functions for the bootloader and os to call
pure interface specification
merely states what interfaces to offer and not how they are implemented nor which or how they are used
goals:
- complete solution describing all features and capabilities
- abstract interfaces to support a range of processors without the need for knowledge about underlying hardware for the bootloader
- sharable persistent storage for platform support code
replace bios but also backwards compatible with Compability Support Module (CMS)
supports boot from media containing UEFI OS loader or UEFI System Partition
does not require changes to the first sector, this allows media to boot legacy and uefi at the same time
security

\subsection{Boot Sequence}

focus will be on dxe and transient system load

\begin{enumerate}
    \item{\acf{SEC}}

    first phase
    establishment of root of trust
    handles platform restart
    temporary memory in CPU cache (CAR) cache as ram, no evictions mode

    \item{\acf{PEI}}

    initialize stuff

    \item{\acf{DXE}}

    dxe core
    dxe dispatcher
    depex
    dxe drivers

    \item{\acf{BDS}}


    \item{\acf{TSL}}

    boottime and runtime services/driver
    bootloader
    ExitBootServices()

    \item{\acf{RT}}

    runtime services/driver

    \item{\acf{AL}}

    hibernation
    sleep

\end{enumerate}

\subsection{\acs{UEFI}/\acs{PI} Firmware Images}

flash device
flash volume
flash file system
file sections
depex

\subsection{\acs{UEFI} Images}

executable
subset of PE32+ file format with modified header signature to distinguish from normal PE32 Images
+ stands addition of 64-bit relocation fix-up extension
fixed and dynamic address loading
relocatable
boot and runtime memory
application vs os loader vs driver
loaded fully into memory and reloaction fix ups
memory marked as code and data
jump to entry point
what is the boot manager

\subsubsection{\acs{UEFI} Applications}

example efi shell
loaded by boot manager or other applications
return or calling exit specifically
always unloaded from memory

\subsubsection{UEFI OS Loaders}

example windows boot manager
normally take over control from the firmware
upon load behaves like a normal UEFI application
- only use memory allocated from the firmware
- only use services/protocols to access devices that the firmware exposes
- conform to driver specifications to access hardware
on error can return allocated resources with Exit boot service with error specific information given in ExitData
on success take full control with ExitBootServices boot service
all boot services in the system are terminated, including memory management
UEFI OS loader now responsible

\subsubsection{UEFI Drivers}

loaded by boot manager, UEFI firmware (DXE foundation), or other applications
example payload
unloaded only when returning error code
presistent on success
boot and runtime drivers
only difference is that runtime are available after ExitBootServices was called
boottime drivers are terminated and memory is released
runttime drivers are fixed up with virtual mappings upon SetVirtualAddressMap call
has to convert its allocated memory

\subsection{Firmware Core}

boot and runtime services
boot service table
guids
handles and protocols
protocols

\subsection{edk2}
build system

\subsection{Security}
% https://edk2-docs.gitbook.io/understanding-the-uefi-secure-boot-chain/
\subsubsection{Secure Boot}
% https://edk2-docs.gitbook.io/understanding-the-uefi-secure-boot-chain/secure_boot_chain_in_uefi/uefi_secure_boot
\subsubsection{Signed Capsule Update}
SMM

\section{Windows}
\subsection{User Access Control (UAC)}
\subsection{Signing}
\subsection{Bitlocker}
\subsubsection{TPM}
how does it work
explain TPM