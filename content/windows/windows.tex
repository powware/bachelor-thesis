% !TeX root = ../../thesis.tex


\chapter{Windows 11}
\label{sec:windows}

Windows 11 is, at the time of writing, the latest iteration in the line of desktop \acp{OS} from Microsoft.
It is built upon the foundation of Windows 10 and, as such, shares many security settings and policies with its predecessor \cite{microsoft-windows-11-overview}.
Simultaneously, it raises the requirements of hardware\-/related security features.
It does not support being booted from legacy \ac{BIOS} anymore and requires the \ac{PF} to conform to at least \ac{UEFI} version 2.3.1 and to be capable of Secure Boot.
It also requires the presence of a \ac{TPM} version 2.0 \cite{microsoft-windows-minimum-hardware-requirements-overview}.

\section{\acs{UEFI}}

To be able to analyze \ac{UEFI} threats against Windows 11 it is important to understand how Windows interacts with the \ac{UEFI} environment.

\subsection{Installation}

The interaction with \ac{UEFI} begins with the installation process and the partitioning of the hard drive Windows is installed onto.
% creates at least four partitions
When the Windows Installer is launched, it creates at least four \ac{GPT} partitions on the target hard drive: the \acf{ESP}, a recovery partition, a partition reserved for temporary storage, and the boot partition containing the system files.
Two copies of the \emph{Windows Boot Manager} \program{bootmgfw.efi} are placed on the \ac{ESP}, one under \program{EFI\brackslash Boot\brackslash bootx64.efi} for the default boot behavior (i.e., booting from the installed hard drive) and one under \program{EFI\brackslash Microsoft\brackslash Boot\brackslash bootmgfw.efi} alongside boot resources such as the \ac{BCD}.
The path of the latter boot manager is saved in a boot load option variable entry \code{Boot\#\#\#\#}, which is then added to the \code{BootOrder} list variable.
The boot load option contains optional data consisting of a \ac{GUID} identifying the Windows Boot Manager entry in the \ac{BCD}.
The \ac{BCD}, as its name suggests, contains arguments used to configure various steps of the boot process \cite[Section 12]{windows-internals-7-part2}.
The boot partition is the primary Windows partition.
It is formatted with the \ac{NTFS} file system containing the Windows installation.
This is also the location of the final step of the Windows \ac{UEFI} boot process, \program{Windload.efi}, the application responsible for loading the kernel into memory \cite[Section 12]{windows-internals-7-part2}.

\subsection{Boot}

Now that we have established the basic structure of the Windows \ac{UEFI} boot environment, we can discuss the boot process.
The Windows boot process begins after the \ac{UEFI} Boot Manager launches the Windows Boot Manager, which starts by retrieving its executable path and the \ac{BCD} entry \ac{GUID} from the boot load options.
Then it loads the \ac{BCD} and accesses its entry.
If not disabled in the \ac{BCD}, it loads its own executable into memory for integrity verification \cite[Section 12]{windows-internals-7-part2}.
Depending on what hibernation status is set within the \ac{BCD}, it may launch the \program{Winresume.efi} application, which reads the hibernation file and resumes the kernel execution \cite[Section 12]{windows-internals-7-part2}.
On a full boot, it checks the \ac{BCD} for boot entries.
If the entry points to a BitLocker encrypted drive, it attempts decryption.
If this fails a recovery prompt is displayed, otherwise the system proceeds to load the \ac{OS} loader \program{Windload.efi} which maps the kernel image \program{ntoskernl.exe} into memory. After a call to \code{ExitBootServices()} it transfers execution to the kernel \cite[Section 12]{windows-internals-7-part2}.

\subsection{Runtime}

During runtime, Windows uses the variable services to communicate with the \ac{PF} and even exposes these to application developers.
It also supports firmware and option\-/\ac{ROM} updates via the capsule delivery services.

\section{Registry}

A crucial part of the whole Windows ecosystem is the \emph{Registry}.
It is a system database containing the information required to boot, what drivers to load, general system\-/wide configuration as well as application configuration \cite[Section 1]{windows-internals-7-part1}.
The Registry is a hierarchical database containing keys and values, whereas keys can contain other keys or values, forming a tree\-/like structure.
Values store data through various data types.
It is comparable to a file system structure with keys behaving like directories and values behaving like files \cite[Section 10]{windows-internals-7-part2}.
At the top level it has 9 different keys \cite[Section 10]{windows-internals-7-part2}.
Normally Windows users are not required to change Registry values directly and instead interact with it through applications providing setting abstractions.
Although some more advanced options may not be exposed and can be accessed through the \program{regedit.exe} application which provides a graphical user interface to traverse and modify the Registry \cite[Section 10]{windows-internals-7-part2}.
It also supports importing and exporting registry keys along their subkeys and contained values.
Internally, the registry is not a single large file but instead a set of files called \emph{hives}.
Each hive contains one tree that is mapped into the Registry as a whole.
There is no one\-/to\-/one mapping between registry root keys and hive files, the \ac{BCD} file, for example, is also a hive file and is mapped into the Registry under \program{HKEY\underbreak LOCAL\underbreak MACHINE\brackslash BCD00000000} \cite[Section 10]{windows-internals-7-part2}.
Some hives even reside entirely in memory as a means of offering hardware configuration through the Registry \ac{API}.

\input{content/windows/windows_security}