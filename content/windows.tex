% !TeX root = ../thesis.tex

\chapter{Windows 11}

\TODO{what is 11 compared to 10}

\section{Installation}

For us to understand how UEFI threats act towards Windows we need to understand how the layout of the Windows installation integrates into the UEFI environment.
% uefi begins with windows installation
This begins with the installation process and the partitioning of the hard drive Windows is installed onto.
% creates at least four partitions
When the Windows Installer is launched, it creates at least four partitions on the target hard drive.
The \acf{ESP}, a recovery partition, a partition reserved for temporary storage and the boot partition containing the system files.
Two copies of the Windows Boot Manager \lstinline{bootmgfw.efi} are placed on the \ac{ESP}, one under \lstinline{EFI\\Boot\\bootx64.efi} for the default boot behavior the installed hard drive and one under \lstinline{EFI\\Microsoft\\Boot\\bootmgfw.efi} alongside boot resources such as the \ac{BCD}.
The path of the latter boot manager is saved in a boot load option variable entry \lstinline{Boot####}, which is then added to the \lstinline{BootOrder} list variable.
The boot load option contains optional data consiting of a GUID identifying the Windows Boot Manager entry in the \ac{BCD}.
The \ac{BCD}, as its name suggests, contains arguments used to configure various steps of the boot process \cite[12. The Windows Boot Manager]{windows-internals-7-part2}.
The boot partition is the primary Windows partition and is formatted with the \ac{NTFS} file system containing the Windows installation.
This is also the location of the final step of the Windows UEFI boot process, \lstinline{Windload.efi}, the application repsonsible for loading the kernel into memory \cite[12. The Windows OS Loader]{windows-internals-7-part2}.

\section{Boot Process}

Now that we established the basic structure of the Windows UEFI boot environment, we can discuss the boot process.
The Windows boot process begins after the UEFI Boot Manager launches the Windows Boot Manager, which starts by retrieving its own executable path and the \ac{BCD} entry GUID from the boot load options.
Then it loads the \ac{BCD} and access its entry.
If not disabled in the \ac{BCD} it loads its own executable into memory for integrity verification \cite[12. The Windows Boot Manager]{windows-internals-7-part2}.
Depending on what hibernation status is set within the \ac{BCD} it may launch the \lstinline{Winresume.efi} application, which reads the hibernation file and resumes kernel execution \cite[12. Launching a boot application]{windows-internals-7-part2}.
On a full boot it checks the \ac{BCD} for boot entries, if the entry points to a BitLocker encrypted drive, it attempts decryption.
If this faile it will show a reocvery prompt, otherwise it proceeds to load the \lstinline{Windload.efi} \ac{OS} loader \cite[12. Launching a boot application]{windows-internals-7-part2}.

% tries to TPM unseal
% url and message are read from BCD
% if succeeds make sure TPM cant be used to unseal further things
% StartImage os loader, only returns in error case
% if so start Windows Recovery Sequence
\TODO{TPM interaction}
\cite[12. Launching a boot application]{windows-internals-7-part2}


\section{Registry}

A crucial part to the whole Windows ecosystem is the Registry, it is a system database containing information required to boot, such as what drivers to load, general system wide configuration as well as application configuration.
\cite[1. Registry]{windows-internals-7-part1}
The Registry is a hierachical database containing keys and values, keys can contain other keys or values, forming a tree structure.
Values store data through various data types.
It is comparable to a file system structure with keys behaving like directories and values like files \cite[10. The registry - Registry data types]{windows-internals-7-part2}.
At the top level it has 9 different keys \cite[10. The registry - Registry logical structure]{windows-internals-7-part2}.
Normally Windows users are not required to change Registry values directly and instead interact with it through applications providing setting abstractions.
Though some more advanced options may not be exposed and can be accessed through the \lstinline{regedit.exe} application which provides a graphical user interface to travere and modify the Registry \cite[10. The registry - Viewing and changing the registry]{windows-internals-7-part2}.
It also supports ex- and importing registry keys along their subkeys and contained values.
Internally the registry is not a single large file but instead a set of file called hives, each hive contains one tree, that is mapped into the Registry as a whole.
There is no one to one mapping of registry root key to hive file, the \ac{BCD} file for example is also a hive file and is mapped into the Registry under \lstinline{HKEY_LOCAL_MACHINE\BCD00000000} \cite[10. The registry - Registry logical structure]{windows-internals-7-part2}.
Some hives even reside entirely in memory as a means of offering hardware configuration through the Registry \ac{API}.

\TODO{maybe fun fact that EFS cant encrypt hives}
windows also has a feature called Encrypting File System (EFS) with file system level encryption but it cant be used for registry hives
\cite[9. BitLocker Drive encryption]{windows-internals-6-part2}


% https://learn.microsoft.com/en-us/windows/whats-new/windows-11-overview#security-and-scanning
% \subsection{User Access Control (UAC)}
% https://learn.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works

\section{Trusted Boot}
% https://learn.microsoft.com/en-us/windows/security/information-protection/secure-the-windows-10-boot-process
% https://learn.microsoft.com/en-us/windows/security/trusted-boot
% https://www.anoopcnair.com/understanding-windows-trusted-boot/
\subsection{KMCI}
\subsection{HVCI}
% https://learn.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-hvci-enablement

\section{\acf{BDE}}
\label{sec:bde}
Windows is only able to enforce security policies when it is active, leaving the system vulnerable when accessed from outside of the \ac{OS} \cite[9. BitLocker Drive encryption]{windows-internals-6-part2}.
Windows uses BitLocker, integrated \ac{FVE}, aimed to protect system files and data from unauthorized accecss while at rest \cite{microsoft-bitlocker-overview}, while also verifying boot integrity when used with a \ac{TPM} \cite[9. BitLocker Drive encryption]{windows-internals-6-part2}.
The en- and decryption of the volume is done by a filter driver beneath the \ac{NTFS} driver as shown in \autoref{fig:bitlocker-volume-access-driver-stack}.
The \ac{NTFS} driver translates file and directory access into block-wise operations on the volume \TODO{CITE}, the filter driver receives these block operations, encrypting blocks on write and decrypting blocks on read, while they pass through.
This leaves the en- and decryption entirely transparent, making the underlying volume appear decrypted to the \ac{NTFS} driver \cite[9. Full-Volume Encryption Driver]{windows-internals-6-part2}.
The encryption of each block is done using a modified version of the \ac{AES}128 and \ac{AES}256 cypher \cite[9. Encryption Keys]{windows-internals-6-part2}.
A \ac{FVEK} is used in combination with the block index as input for the algorithm, resulting in an entirely different output for two blocks with identical data \cite[9. Full-Volume Encryption Driver]{windows-internals-6-part2}.
The \ac{FVEK} is encrypted with a \ac{VMK} which is in turn encrypted with multiple protectors, these encrypted versions of the \ac{VMK} are stored together with the encrypted \ac{FVEK} in an unencrypted meta data portion at the beginning of the volume \cite[9. Encryption Keys]{windows-internals-6-part2}.
The \ac{VMK} is encrypted by the following protectors:

\begin{itemize}
    \item[Startup key] stored in a \lstinline{.bek} file with a \ac{GUID} name equaling key identifier in bitlocker meta data
        \cite[2.6. Startup key]{bde-format-spec}
    \item[TPM]
        - tpm only
        no additional user interaction
        - tpm with startup key
        additional usb
        - tpm with PIN
        - tpm with startup key and PIN
        \cite{microsoft-bitlocker-countermeasures}
        with tpm ensures integrity of early boot components and boot configuration
        tpm usage requires \ac{TCG}2 compliant \ac{UEFI} firmware \cite[9. TPM]{windows-internals-6-part2}

        tpm is used to \emph{seal} and \emph{unseal} \ac{VMK}
        \TODO{PCR table either here or at TPM section}
        platform validation profile
        default \acp{PCR} are 0, 2, 4, 5, 8, 9, 10 and 11
        11 is required
    \item[Recovery key] recovery key 48 digits of 8 blocks
        block is converted to a 16-bit value making up a 128-bit key
        \cite[2.4. Recovery key]{bde-format-spec}
        % how to obtain
        when enabling manually, save on non encrypted medium
        \cite{microsoft-bitlocker-basic-deployment}

        bitlocker device encryption if supported automatically enabled
        after clean install encrypted with clear key (bitlocker suspended state)
        non domain account -> recovery key uploaded to microsoft account
        domain account -> recovery key backed up to active directory domain services (AD DS)
        clear key removed
        \cite{microsoft-bitlocker-device-encryption}

    \item[User key] password with max 49 characters
        \cite[2.7. User key]{bde-format-spec}
    \item[Clear key] unprotected 256-bit key stored on the volume to decrypt vmk
        \cite[2.5. Clear key]{bde-format-spec}
        used for suspension


        \TODO{decide if we add this} With Windows 11 and Windows 10, administrators can turn on BitLocker and the TPM from within the Windows Pre-installation Environment \cite{microsoft-bitlocker-device-encryption}

        \begin{figure}[htb]%
            \centering
            \includesvg{bitlocker_volume_access_driver_stack.drawio.svg}
            \caption{BitLocker Volume Access Driver Stack, inspired by \cite[Figure 9-24]{windows-internals-6-part2}}%
            \label{fig:bitlocker-volume-access-driver-stack}%
        \end{figure}

\end{itemize}